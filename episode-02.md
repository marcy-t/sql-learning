# episode-02~グループ化と集約〜ぼっちを集めてリア充に

## 前回のおさらい

``` sql
select {表示させたい列名} 
from {表示させたいデータの指定}
where {表示させたいデータの検索条件}
order by {表示させたいデータの整列}
limit {表示させたいデータの制限}
;
```

# group by テーブルの内容をグループに分けて集計ができます。
- 合計する (sum())
- 平均する (avg())
- 最大値を調べる (max()) • 最小値を調べる (min()) 
- 行数を数える (count())

## 前回のテーブル「members」で見てみます
- 次の SQL を実行すると、男女別の平均身長が出せます

``` sql 
select 
    gender
,   avg(height) --  グループごとに平均値を計算 
from 
    members
group by gender -- 性別ごとにグループ化
;
```

- 上記のSQL値が正しいか、確かめてみましょう。
- そのために次の SQL を実行し、男 女別に身長の低い順で整列します。

## 男女別に身長の低い順で整列

``` sql
select 
    *
from 
    members
order by gender desc, height
;
```

- 男女別の平均身長は次のように計算できます。
  - 男子の平均身長: (158+163+170+175) / 4 = 166.5
  - 女子の平均身長: (168+170) / 2 = 169.0
  
# グループ化
- グループ化 (Grouping) とは、何らかのキーを使って行をいくつかのグループ にまとめることです。
- 「行」をグループにするのがポイント
- 前回のクエリを見てみましょう

``` sql
select 
    gender
,   avg(height) --  グループごとに平均値を計算 
from 
    members
group by gender -- 性別ごとにグループ化
;
```
- 「avg()」のように、グループから複数の値を受け取って何らかの値を計算する関数を集約関数 (Aggregate function) と言います


# 集約関数
- sum() ... 合計する
- avg() ... 平均する
- max() ... 最大値を調べる
- min() ... 最小値を調べる
- count() ... 行数を数える

## 男女別に、身長の最大値と最小値と合計値と行数と平均値を計算する

``` sql
select 
    gender
,   max(height)
,   min(height)
,   sum(height)
,   count(*)
,   to_char(avg(height), '999.99') -- 小数点100の位まで出す
from 
    members
group by gender --性別でグループ化 
order by gender desc
;
```

## count(*)だけなんで*?
- この「*」は「行そのもの」を表しています。なので
- 「count(*)」は「行の数を数える」という意味になります。
- count(height)にかくと値が入っていないものに関してはカウントしません


# having

- group by 句によって行をグループ化できることを説明しました。
- having 句を 使うと、それらのグループに対して選択条件を指定できます。

## 性別でグループ化してから、それぞれの平均身長を表示
``` sql 
select 
    gender
,   avg(height) --  グループごとに平均値を計算 
from 
    members
group by gender -- 性別ごとにグループ化
;
```
- もしこの内容がまだ理解しきれていない場合 は、前の節を読み直すと良いでしょう。
- これのグループに対して、平均身長が 168cm 以上のグループだけを表示してみましょう。
- そのためには having 句を使います。having 句を使うと、グ ループをフィルタできます。

### 性別でグループ化してから、平均身長が 168cm 以上のグループだけを表示
``` sql 
select
    gender
,   avg(height)
from 
    members
group by gender
having avg(height) >= 168 -- 平均値が168以上のグループだけ選ぶ
; 
```

> この実行結果では女子(gender が F)のグループだけが表示され、男子(gender が M)のグループは表示されませんでした。
> なぜなら平均身長が 168cm 以上の グループだけを表示するよう、having 句で指定したからです。
- 男子グループの平均身長は 166.5cm だから表示されなかった。
- 女子グループの平均身長は 169.0cm だから表示された。

# where 句と having 句の違い
- 大きく違うのは「選択する対象が違います」

## where
- テーブルの「行」を対象とします。条件に合った行だけ が選択され、合わなかった行は無視されます。

# having
- 「グループ」を対象とします。条件に合ったグループだけが選択され、合わなかったグループは無視されます。

# 原則
- 次の原則を覚えてください。
 - group by 句でグループ化される前は、行が操作対象
 - group by 句でグループ化された後は、グループが操作対象

### 上記の集計条件が頭に入っていないと他のデータ（テーブル）を結合させたときに集計ぐちゃぐちゃになります（めっちゃ行が意味わからんくらい増える）

# 問題
- 問題 1:男女別に集計
 - メンバーにおいて、人数と平均身長を男女別に集計してください。
- 問題 2:最大値と最小値の差
  - メンバーにおいて、最高身長と最低身長、そしてその 2 つの差を男女別 に集計してください。出力結果は、1 行目が男子、2 行目が女子になるようにし てください。
  - 身長差を求めるには「max(height) - min(height)」とかくと出ます。
``` shell
# 最高身長と最低身長とその 2 つの差を、男女別に集計
gender | max | min | ?column? 
--------+-----+-----+---------- 
M | 175 | 158 | 17 
F | 170 | 168 | 2
```


 
